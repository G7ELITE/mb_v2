# ManyBlack V2 ‚Äî README-ROADMAP (‚úÖ Completo ‚Ä¢ Backend + Frontend Studio)

> **üéØ Status Atual**: ‚úÖ **Fase 1 Completa** - Sistema totalmente funcional com backend FastAPI e frontend React
> 
> **Vis√£o**: Plataforma completa de convers√£o/atendimento orientada a **contexto**, com interface visual amig√°vel em portugu√™s para equipes operacionais. Dois tipos de intera√ß√£o por turno: **D√∫vida** (resposta pontual, controlada por cat√°logo) e **Procedimento** (funis flex√≠veis passo a passo).  
> 
> **Arquitetura**: **Intake Agent** (inteligente) processa mensagens e executa ferramentas; **Orquestrador** decide com base em **Lead Snapshot** enriquecido; **Workers/Tools** realizam verifica√ß√µes externas; **ManyBlack Studio** permite configura√ß√£o visual em **PT‚ÄëBR**.
> 
> **‚ú® Novidades**: Interface visual completa, modo escuro, simulador integrado, dashboard em tempo real

---

## ‚úÖ Implementado - ManyBlack Studio (Frontend Visual)

### üé® Interface Completa em Portugu√™s
- **Dashboard**: Vis√£o geral em tempo real com m√©tricas de sa√∫de do sistema
- **Procedimentos**: Editor visual de funis com passos sequenciais
- **Automa√ß√µes**: CRUD completo de mensagens autom√°ticas com bot√µes
- **Intake & √Çncoras**: Configura√ß√£o de detec√ß√£o de inten√ß√µes
- **Simulador**: Teste de conversas com modo desenvolvedor
- **Publica√ß√£o**: Deploy de configura√ß√µes (estrutura preparada)

### üåü Recursos de UX/UI
- **üáßüá∑ 100% PT-BR**: Interface totalmente em portugu√™s brasileiro
- **üåô Modo Escuro**: Design moderno com alto contraste
- **üì± Responsivo**: Funciona em desktop, tablet e mobile
- **üéõÔ∏è Sidebar Colaps√°vel**: Maximize √°rea de trabalho
- **‚ö° Blocos Colaps√°veis**: Visualize apenas o necess√°rio
- **üîÑ Transi√ß√µes Suaves**: Experi√™ncia fluida e moderna

### üõ†Ô∏è Stack Tecnol√≥gica do Frontend
- **React 18** + TypeScript para UI robusta
- **Tailwind CSS v4** para estiliza√ß√£o moderna
- **React Router** para navega√ß√£o client-side
- **React Query** para cache e sincroniza√ß√£o
- **React Hook Form** para formul√°rios otimizados
- **Heroicons** para √≠cones consistentes

---

## 0) Metas & Princ√≠pios

1. **Controle com previsibilidade**: priorizar **automa√ß√µes do cat√°logo** (templates) para respostas cr√≠ticas; **fallback** com KB apenas quando necess√°rio.
2. **Decis√£o em 1 turno**: minimizar ping‚Äëpong de prompts; orquestrador constr√≥i e aplica **plano idempotente** (um batch de a√ß√µes).
3. **Intelig√™ncia com seguran√ßa**: **Intake Agent** interpreta entradas amb√≠guas (‚Äú`8989453289`‚Äù, ‚Äú`email@gmail.com`‚Äù) usando contexto do fluxo e **executa at√© 2 tools**; s√≥ pergunta quando necess√°rio (com bot√µes rastre√°veis).
4. **Sem duplica√ß√£o de verifica√ß√µes**: o orquestrador **n√£o chama APIs externas** ‚Äî ele **decide** com base nos **fatos** que chegam no snapshot.
5. **Observabilidade/qualidade desde o in√≠cio**: logs estruturados, m√©tricas de lat√™ncia e utiliza√ß√£o, auditoria de decis√µes.
6. **Edi√ß√£o em PT‚ÄëBR**: cat√°logo/procedimentos/regras s√£o escritos em linguagem natural e **compilados** para predicados internos (DSL ‚Äúpor baixo do cap√¥‚Äù).

---

## 1) Gloss√°rio

- **Turno**: ciclo de decis√£o referente a uma janela coalescida de mensagens do lead ou a um evento de sistema (ex.: verifica√ß√£o conclu√≠da).  
- **Lead Snapshot**: estado consolidado (contas, dep√≥sito, acordos/concord√¢ncias, flags, resumo de hist√≥rico e verifications).  
- **D√∫vida**: pergunta pontual respondida por cat√°logo/KB; n√£o altera fluxo de marcos.  
- **Procedimento**: sequ√™ncia ordenada de passos que guiam o lead at√© um objetivo (ex.: *Liberar teste*, *Liberar VIP*).  
- **Intake Agent**: agente de entrada que interpreta mensagem crua, usa contexto e **executa tools** com or√ßamento controlado.
- **Workers/Tools**: servi√ßos que verificam cadastro/dep√≥sito e atualizam o estado.  
- **Apply Plan**: endpoint que aplica a√ß√µes (mensagens, bot√µes, tags‚Ä¶), **idempotente**.

---

## 2) Arquitetura (alto n√≠vel)

```
[ Telegram / WhatsApp ]
        ‚îÇ
        ‚ñº
[ Webhook ] ‚îÄ‚îÄ‚ñ∫ [ Snapshot Builder ] ‚îÄ‚îÄ‚ñ∫ [ Intake Agent ] ‚îÄ‚îÄ‚ñ∫ [ Orquestrador ] ‚îÄ‚îÄ‚ñ∫ [ Apply Plan ]
                                   ‚îÇ                        (decide/planeja)        (batch idempotente)
                                   ‚îî‚îÄ‚îÄ‚ñ∫ [ Workers/Tools (verify_signup, check_deposit) ]
                                            ‚ñ≤
                                            ‚îî‚îÄ‚îÄ Atualizam estado e disparam turno de sistema
```

**Pap√©is**  
- **Snapshot Builder (determin√≠stico)**: normaliza evento (canal), extrai evid√™ncias (regex/√¢ncoras), funde com estado e **n√£o decide**. Pode enfileirar jobs para workers e marcar `pending_ops`.  
- **Intake Agent (inteligente)**: usa contexto do fluxo (passo ativo, hist√≥rico curto) + padr√µes confi√°veis (e‚Äëmail/ID por corretora) + 1 chamada LLM para desambiguar e **executa at√© 2 tools** (paralelas quando √∫til).  
- **Orquestrador**: l√™ o snapshot e decide **D√∫vida** x **Procedimento**; escolhe automa√ß√£o/checkpoint; constr√≥i **plano**; **n√£o verifica** externamente.  
- **Workers/Tools**: executam verifica√ß√µes; ao concluir, **persistem fatos** e disparam **turno de sistema** com o snapshot atualizado.  
- **Apply Plan**: aplica a√ß√µes (texto, m√≠dia, bot√µes com tracking) em batch idempotente.

---

## 3) Fluxos can√¥nicos

### 3.1 D√∫vida
1. Webhook ‚Üí Snapshot Builder ‚Üí Intake (geralmente sem tools).  
2. Orquestrador tenta **cat√°logo**; se n√£o houver, **KB** (RAG‚Äëlite com guardrails).  
3. Apply Plan envia resposta; registra `automation_run` e `message_sent`.

### 3.2 Procedimento (ex.: ‚ÄúLiberar teste‚Äù)
1. Webhook ‚Üí Snapshot Builder ‚Üí Intake: detecta `email`/`account_id` e **verifica** com alta confian√ßa (Nyrion/Quotex conforme contexto).  
2. Snapshot enriquecido (ex.: `accounts.nyrion="com_conta"`, `agreements.can_deposit=true`).  
3. Orquestrador executa **passos**:  
   - *Concorda em depositar* ‚Üí usa `agreements.can_deposit` (n√£o pergunta).  
   - *Criou conta* ‚Üí se n√£o, dispara `signup_link`.  
   - *Dep√≥sito confirmado* ‚Üí se n√£o, `prompt_deposit`; se sim, `trial_unlock`.  
4. Apply Plan registra `procedure_run + automation_run`.  
5. Se dep√≥sito confirmar depois ‚Üí **turno de sistema** conclui.

---

## 4) Lead Snapshot (contrato)

```json
{
  "lead": {"id": 9123, "nome": "Gabriel", "lang": "pt-BR"},
  "snapshot": {
    "accounts": {"quotex": "com_conta", "nyrion": "sem_conta"},
    "deposit": {"status": "pendente"},
    "agreements": {"can_deposit": true, "wants_test": true},
    "flags": {"explained": true},
    "history_summary": "Perguntou OTC; disse que vai depositar; quer testar.",
    "verifications": [
      {"kind":"signup","broker":"nyrion","input":{"account_id":"8989453289"},"outcome":"verified","confidence":0.92}
    ]
  },
  "messages_window": [{"id":"m1","text":"quero testar"}],
  "apply": true,
  "now": "2025-08-30T14:45:00-03:00"
}
```

**Observa√ß√µes**  
- Concord√¢ncia do lead vale como fato: `agreements.can_deposit=true` (n√£o usamos saldo).  
- `verifications[]` documenta o que o Intake/Workers checaram (auditoria).

---

## 5) Cat√°logo (PT‚ÄëBR) e compila√ß√£o

### 5.1 Modelo de automa√ß√£o
```yaml
- id: ask_deposit_for_test
  topic: "teste"
  use_when: "o lead quer testar"
  eligibility: "n√£o concordou em depositar e n√£o depositou"
  priority: 0.85
  cooldown: 24h
  output:
    type: message
    text: "Para liberar o teste, voc√™ consegue fazer um pequeno dep√≥sito?"
    media:
      - kind: photo
        url: "https://cdn/dep.png"
        caption: "Passo a passo"
    buttons:
      - id: btn_yes_deposit
        label: "Sim, consigo"
        kind: callback
        set_facts: {agreements.can_deposit: true}
        track: {event: "click_yes_deposit", utm_passthrough: true}
      - id: btn_help_deposit
        label: "Como deposito?"
        kind: url
        url: "{{deposit_help_link}}"
        track: {event: "open_deposit_help"}
```

### 5.2 Compila√ß√£o PT‚ÄëBR ‚Üí predicados
- ‚Äún√£o concordou em depositar e n√£o depositou‚Äù ‚Üí `not agreements.can_deposit and deposit.status in ["nenhum","pendente"]` (exemplo).  
- Compilador retorna: `predicate_ast`, `confidence`, `mapping` (para auditoria).  
- A equipe **s√≥ escreve PT‚ÄëBR**; a DSL √© interna.

---

## 6) Procedimentos (PT‚ÄëBR)

### 6.1 Modelo
```yaml
id: liberar_teste
title: "Liberar teste"
steps:
  - name: "Concorda em depositar"
    condition: "o lead concordou em depositar ou j√° depositou"
    if_missing: {automation: "ask_deposit_for_test"}

  - name: "Criou conta"
    condition: "tem conta em alguma corretora suportada"
    if_missing: {automation: "signup_link"}

  - name: "Dep√≥sito confirmado"
    condition: "dep√≥sito confirmado"
    if_missing: {automation: "prompt_deposit"}

  - name: "Liberar"
    condition: "todas as etapas anteriores cumpridas"
    do: {automation: "trial_unlock"}
```

### 6.2 Execu√ß√£o (runtime)
- Avalia **em ordem**; primeiro passo n√£o satisfeito ‚Üí dispara `if_missing.automation` e encerra turno.  
- Se todos satisfeitos ‚Üí executa `do`.  
- **Sem verifica√ß√£o ativa**; usa somente os **fatos do snapshot**.

### 6.3 Pseudoc√≥digo
```python
def run_procedure(proc, snapshot):
    for step in proc.steps:
        if not satisfies(step.condition, snapshot):
            return Action("run_automation", automation_id=step.if_missing.automation, step=step.name)
    return Action("run_automation", automation_id=proc.final or "trial_unlock", step="done")
```

---

## 7) Intake Agent ‚Äî pol√≠tica, confian√ßa e ferramentas

### 7.1 Pol√≠tica
```yaml
intake_policy:
  llm_budget: 1
  tool_budget: 2
  max_latency_ms: 3000
  thresholds:
    direct: 0.80         # chamar tool direta (um broker)
    parallel: 0.60       # chamar tools em paralelo (multi-broker)
  broker_priority:
    - by_active_procedure
    - by_profile_known
    - fallback_parallel
  anchors:
    email: ["email", "e-mail", "mail"]
    id: ["id", "conta", "login", "n√∫mero da conta"]
  id_patterns:
    nyrion: ["\\b[0-9]{6,12}\\b"]
    quotex: ["\\b[a-zA-Z0-9]{6,16}\\b"]
```

### 7.2 Regras
- **Contexto primeiro**: se o passo ativo pede ‚ÄúID/e‚Äëmail Nyrion‚Äù, e chega ‚Äú`8989453289`‚Äù, chame `verify_signup(nyrion)` direto.  
- **Padr√µes e e‚Äëmail**: regex de e‚Äëmail confi√°vel; padr√µes por corretora para ID.  
- **Paralelismo**: d√∫vida de corretora ‚Üí tentar Nyrion+Quotex em paralelo (dentro do or√ßamento).  
- **Evitar atrito**: s√≥ perguntar se a confian√ßa < `parallel` ou se as tools falham.

### 7.3 Ferramentas (contratos)
- `POST /tools/verify_signup` ‚Üí `{broker, email?, account_id?}` ‚Üí `{verified:bool, details?}`  
- `POST /tools/check_deposit` ‚Üí `{broker, email?/account_id}` ‚Üí `{status:"nenhum|pendente|confirmado"}`

---

## 8) Mensagens, bot√µes e rastreamento

### 8.1 Payload unificado (independente de canal)
```json
{
  "type":"message",
  "text":"Crie sua conta: {{signup_link}}",
  "media":[{"kind":"photo","url":"https://cdn/step.png","caption":"Passo a passo"}],
  "buttons":[
    {"id":"btn_open_signup","label":"Abrir cadastro","kind":"url","url":"{{signup_link}}",
     "track":{"event":"open_signup","utm_passthrough":true}}
  ]
}
```

### 8.2 Mapeamento por canal
- **Telegram**: inline keyboard (URL/Callback), m√≠dia com `caption`, `parse_mode`.  
- **WhatsApp**: URL buttons e Quick Replies; limites de tamanho/tempo.

### 8.3 Eventos
- `message_sent`, `automation_run`, `button_clicked`, `procedure_run`, `journey_event`.  
- `utm_passthrough`: replica UTM do lead no clique do bot√£o (para atribui√ß√£o).

---

## 9) Dados & Esquema (SQLAlchemy)

- `lead(id, platform_user_id, name, lang, created_at, ...)`
- `lead_profile(lead_id PK, accounts JSONB, deposit JSONB, agreements JSONB, flags JSONB)`
- `automation_run(id, lead_id, automation_id, payload JSONB, created_at)`
- `procedure_run(id, lead_id, procedure_id, step, outcome, created_at)`
- `journey_event(id, lead_id, type, payload JSONB, created_at)`
- `lead_touchpoint(id, lead_id, utm_id, event, ts)`
- `idempotency_key(key PK, response JSONB, created_at)`

**√çndices**: `(lead_id, created_at desc)`; `GIN` em JSONB (`accounts/deposit/agreements`).

---

## 10) Endpoints (contratos)

- `POST /channels/telegram/webhook?secret=...`  
- `POST /engine/decide` (entrada: Lead Snapshot; sa√≠da: plano + logs)  
- `POST /api/tools/apply_plan` (idempotente; `X-Idempotency-Key`)  
- `POST /tools/verify_signup` / `POST /tools/check_deposit` (workers)

**Plano (exemplo)**
```json
{
  "decision_id":"dec_9123_777",
  "actions":[
    {"type":"send_message","lead_id":9123,"text":"Crie sua conta: {{signup_link}}",
     "buttons":[{"id":"btn_open_signup","label":"Abrir cadastro","kind":"url","url":"{{signup_link}}"}]}
  ],
  "logs":{"type":"procedimento","proc":"liberar_teste","step":"Criou conta","latency_ms":680}
}
```

---

## 11) Performance & Confiabilidade

- **Or√ßamentos**: Intake `‚â§3s` (1 LLM + 2 tools), Orquestrador `‚â§2s` (1 LLM).  
- **Coalescer**: janela 1.5‚Äì3s; mutex por lead; `turn_seq` para ordem.  
- **Idempot√™ncia**: `decision_id` + `X-Idempotency-Key`.  
- **Circuit breakers**: para tools externas quando erro ‚â• limiar.  
- **Cache curto**: TTL 60s para checks externos frequentes.  
- **SLIs/SLOs**:  
  - p95 lat√™ncia do turno: **‚â§ 2.5s** (orquestrador), **‚â§ 3.5s** (intake).  
  - Taxa de sucesso de apply: **‚â• 99.5%**.  
  - Erros 5xx do motor: **‚â§ 0.5%**.

---

## 12) Seguran√ßa & Privacidade

- **Sem valores sens√≠veis** (saldo): usar apenas `agreements.can_deposit`.  
- **Mascarar PII** em logs (e‚Äëmail parcial, ID truncado).  
- **Auth**: JWT para tools privadas e `/api/tools/apply_plan`.  
- **Permiss√µes** por escopo (leitura/execu√ß√£o/telemetria).

---

## 13) Testes (matriz)

- **Unit**:  
  - compilador PT‚ÄëBR‚Üípredicados (automa√ß√µes/procedimentos).  
  - selector (eligibility/priority/cooldown).  
  - procedures runtime (ordem/short‚Äëcircuit).  
  - planner (render de bot√µes/track/set_facts).

- **Integra√ß√£o**:  
  - intake (mensagens curtas ‚Äú`8989453289`‚Äù/‚Äú`email@gmail.com`‚Äù ‚Üí verify).  
  - snapshot builder + intake + orquestrador (D√∫vida/Procedimento).  
  - workers (verify/check) + turno de sistema.

- **E2E**:  
  - Telegram webhook ‚Üí intake ‚Üí decide ‚Üí apply ‚Üí ledger.  
  - Cen√°rios: *Liberar teste*, *D√∫vida ‚öô KB fallback*, concorr√™ncia de mensagens.

- **Dados sint√©ticos**:  
  - leads com UTM variada;  
  - procedimentos ‚Äúliberar_teste‚Äù e ‚Äúliberar_vip‚Äù;  
  - automa√ß√µes de ‚Äúexplicar‚Äù, ‚Äúteste j√° usado‚Äù, ‚Äúcadastro‚Äù.

---

## 14) Opera√ß√£o & Runbook

- **Erros de canal** (Telegram/WA): registrar update bruto + causa; reprocessar se transit√≥rio.  
- **Verifica√ß√£o lenta**: responder com ACK (‚Äúconferindo‚Ä¶‚Äù) e registrar `pending_ops`; resultado chega por **turno de sistema**.  
- **Mensagens simult√¢neas**: coalescer; prioridade a callbacks de bot√£o para fechar janela.  
- **Feature flags**: ligar/desligar procedimentos, pol√≠ticas do intake e automa√ß√µes espec√≠ficas.  
- **Backups**: pg_dump di√°rio (fora do escopo deste doc, mas recomendado).

---

## 15) Amostras (prontas para copiar)

### 15.1 `policies/procedures.yml`
```yaml
- id: liberar_teste
  title: "Liberar teste"
  steps:
    - name: "Concorda em depositar"
      condition: "o lead concordou em depositar ou j√° depositou"
      if_missing: {automation: "ask_deposit_for_test"}

    - name: "Criou conta"
      condition: "tem conta em alguma corretora suportada"
      if_missing: {automation: "signup_link"}

    - name: "Dep√≥sito confirmado"
      condition: "dep√≥sito confirmado"
      if_missing: {automation: "prompt_deposit"}

    - name: "Liberar"
      condition: "todas as etapas anteriores cumpridas"
      do: {automation: "trial_unlock"}
```

### 15.2 `policies/catalog.yml`
```yaml
- id: signup_link
  topic: "cadastro"
  use_when: "precisa criar conta"
  eligibility: "n√£o tem conta em nenhuma corretora suportada"
  output:
    type: message
    text: "Crie sua conta aqui: {{signup_link}}"
    buttons:
      - id: btn_open_signup
        label: "Abrir cadastro"
        kind: url
        url: "{{signup_link}}"
        track: {event: "open_signup", utm_passthrough: true}

- id: trial_unlock
  topic: "teste"
  use_when: "todas as etapas cumpridas"
  eligibility: "dep√≥sito confirmado"
  output:
    type: message
    text: "Tudo certo! ‚úÖ Seu teste est√° liberado. Quer ajuda para come√ßar?"
```

### 15.3 `policies/policy_intake.yml`
```yaml
llm_budget: 1
tool_budget: 2
max_latency_ms: 3000
thresholds:
  direct: 0.80
  parallel: 0.60
anchors:
  email: ["email", "e-mail", "mail"]
  id: ["id", "conta", "login", "n√∫mero da conta"]
id_patterns:
  nyrion: ["\\b[0-9]{6,12}\\b"]
  quotex: ["\\b[a-zA-Z0-9]{6,16}\\b"]
```

---

## 16) Roadmap de entrega (fases)

- **F1 (Core)**: Snapshot Builder, Intake Agent, Orquestrador, Cat√°logo (PT‚ÄëBR), Procedimentos base (liberar_teste), Apply Plan idempotente, Telegram webhook.  
- **F2 (Conte√∫do & M√©tricas)**: KB fallback, tracking completo de bot√µes, preparo de UTM (facts/views).  
- **F3 (Escala & Confiabilidade)**: WhatsApp, circuit breakers, cache, otimiza√ß√µes de p95, observabilidade (lat√™ncia, erros, tokens).  
- **F4 (Painel futuro)**: CRUD de **cards de procedimentos** (shadcn), presets de m√©tricas ‚Äî **fora deste escopo**.

---

## 17) Crit√©rios de aceite (MVP)

- **Procedimento ‚Äúliberar_teste‚Äù** operando fim‚Äëa‚Äëfim.  
- Mensagens curtas ‚Äú`8989453289`‚Äù/‚Äú`email@gmail.com`‚Äù tratadas pelo **Intake**:  
  - com contexto ‚Üí verifica em sil√™ncio e avan√ßa;  
  - sem contexto suficiente ‚Üí pergunta m√≠nima com bot√µes rastre√°veis.  
- **D√∫vidas** respondidas por cat√°logo/KB.  
- **Planos idempotentes**; **logs** e **eventos** persistidos.  
- p95 **‚â§ 3.5s** (Intake) / **‚â§ 2.5s** (Orquestrador).

**FIM ‚Äî README-ROADMAP**